<?php

/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 * Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ media_file_path Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ messages
 */

require_once 'vendor/autoload.php';

use TgParser\Database;

echo "ğŸ”„ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...\n";

try {
    // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    $database = new Database();
    $pdo = $database->getPdo();
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ ÑƒĞ¶Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° media_file_path
    $stmt = $pdo->query("PRAGMA table_info(messages)");
    $columns = $stmt->fetchAll();
    
    $columnExists = false;
    foreach ($columns as $column) {
        if ($column['name'] === 'media_file_path') {
            $columnExists = true;
            break;
        }
    }
    
    if ($columnExists) {
        echo "âœ… ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° media_file_path ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚. ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ.\n";
    } else {
        echo "â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ media_file_path...\n";
        
        // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ
        $sql = "ALTER TABLE messages ADD COLUMN media_file_path TEXT";
        $pdo->exec($sql);
        
        echo "âœ… ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° media_file_path ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°!\n";
    }
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ¼ĞµĞ´Ğ¸Ğ°Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ², ĞµÑĞ»Ğ¸ ĞµĞµ Ğ½ĞµÑ‚
    $mediaDir = __DIR__ . '/media';
    if (!is_dir($mediaDir)) {
        mkdir($mediaDir, 0755, true);
        echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¿Ğ°Ğ¿ĞºĞ° Ğ´Ğ»Ñ Ğ¼ĞµĞ´Ğ¸Ğ°Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: {$mediaDir}\n";
    } else {
        echo "ğŸ“ ĞŸĞ°Ğ¿ĞºĞ° Ğ´Ğ»Ñ Ğ¼ĞµĞ´Ğ¸Ğ°Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚: {$mediaDir}\n";
    }
    
    echo "ğŸ‰ ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!\n";
    
} catch (Exception $e) {
    echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸: " . $e->getMessage() . "\n";
    exit(1);
}