# Обновление системы хранения медиафайлов

## Изменения

Система была обновлена для скачивания и локального хранения медиафайлов вместо сохранения только `media_file_id` от Telegram API.

### Что изменилось:

1. **Новая колонка в БД**: Добавлена колонка `media_file_path` в таблицу `messages`
2. **Автоматическое скачивание**: Все медиафайлы теперь скачиваются и сохраняются локально
3. **Структура хранения**: Файлы сохраняются в папке `media/` с именами вида:
   ```
   {media_type}_{chat_id}_{message_id}_{file_id_suffix}.{extension}
   ```

### Примеры имен файлов:
- `photo_-1001234567890_123_BAADrwAAag.jpg`
- `video_-1001234567890_124_CAADrwAAag.mp4`
- `document_-1001234567890_125_DAADrwAAag.pdf`

## Как обновить

### 1. Выполнить миграцию БД
```bash
php migrate_db.php
```

### 2. Перезапустить бота
```bash
# Если используете Docker
docker-compose restart

# Если запускаете локально
# Остановить текущий процесс и запустить заново
php bot.php
```

### 3. Проверить работу
Отправьте медиафайл в канал и проверьте:
- Файл сохранился в папку `media/`
- В API появилось поле `media_file_path`

## API изменения

### Новое поле в ответах API:
```json
{
  "media_file_id": "BAADBAADrwADBREAAYag",
  "media_file_path": "media/photo_-1001234567890_123_BAADrwAAag.jpg"
}
```

### Структура папки media:
```
media/
├── photo_-1001234567890_123_BAADrwAAag.jpg
├── video_-1001234567890_124_CAADrwAAag.mp4
├── document_-1001234567890_125_DAADrwAAag.pdf
└── audio_-1001234567890_126_EAADrwAAag.mp3
```

## Преимущества

1. **Независимость от Telegram**: Файлы доступны даже если Telegram API недоступен
2. **Быстрый доступ**: Локальные файлы загружаются быстрее
3. **Резервное копирование**: Можно делать бэкапы всех медиафайлов
4. **Веб-доступ**: Файлы можно раздавать через веб-сервер

## Обратная совместимость

- Поле `media_file_id` сохраняется для совместимости
- Старые записи в БД продолжают работать
- API возвращает оба поля: `media_file_id` и `media_file_path`

## Настройки

### Права доступа к папке media:
```bash
chmod 755 media/
```

### Настройка веб-сервера для раздачи файлов:
```nginx
location /media/ {
    alias /path/to/tgparser/media/;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

## Устранение неисправностей

### Проблема: Файлы не скачиваются
1. Проверьте права на папку `media/`
2. Проверьте доступ к Telegram API
3. Проверьте логи ошибок

### Проблема: Большой размер папки media
1. Настройте ротацию старых файлов
2. Используйте внешнее хранилище (S3, etc.)

### Проблема: Ошибки в логах
Проверьте доступность Telegram Bot API:
```bash
curl "https://api.telegram.org/bot{TOKEN}/getMe"
```